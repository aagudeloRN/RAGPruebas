<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat de Conocimiento</title>
    <link rel="stylesheet" href="/static/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
    <div class="container query-container">
        <div class="main-background">
            <header>
                <img src="/static/logo_blanco.png" alt="Logo Corporativo" style="display: block; margin: 0 auto 1rem auto; max-width: 150px; height: auto;">
                <h1>Sistema de Inteligencia Aumentada</h1>
                <p>Interact煤a con la base de conocimiento de Ruta N Medell铆n.</p>
                <nav class="main-nav">
                    <!-- <a href="/" class="nav-button">Cargar Documento</a> -->
                    <a href="/library" class="nav-button">Ver Biblioteca</a>
                    <a href="/faq" class="nav-button">Top Q&A</a>
                    <button id="new-chat-btn" class="nav-button">Nueva Conversaci贸n</button>
                </nav>
            </header>

            <div id="reasoning-trace" class="reasoning-trace" style="display: none;">
                <h4>Proceso de Pensamiento:</h4>
                <div id="trace-content"></div>
            </div>

            <div id="chat-window" class="chat-window"></div>

            <div id="loading-spinner" class="loading-spinner" style="display: none;">
                <div class="spinner"></div>
                <p>Pensando...</p>
            </div>

            <div class="chat-input-area">
                <form id="chat-form">
                    <textarea id="chat-input" name="query" rows="1" placeholder="Escribe tu pregunta..."></textarea>
                    <button type="submit" class="btn btn-primary">Enviar</button>
                </form>
                <div id="context-warning" class="context-warning" style="display: none;">
                    La conversaci贸n es larga. Para obtener mejores resultados, considera <a href="#" onclick="startNewChat()">iniciar una nueva conversaci贸n</a>.
                </div>
                <div class="disclaimer">
                    <p><strong>Descargo de Responsabilidad:</strong> Este sistema de inteligencia aumentada es una herramienta de apoyo desarrollada por Ruta N. La informaci贸n generada, aunque se basa en fuentes y metodolog铆as robustas (RAG), puede contener errores. Su uso es responsabilidad exclusiva del usuario, quien, en cumplimiento del principio de buena fe (Art. 83, Const. de Colombia), debe verificar la informaci贸n antes de tomar cualquier decisi贸n. Este sistema no reemplaza la consultor铆a profesional.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const chatWindow = document.getElementById('chat-window');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const newChatBtn = document.getElementById('new-chat-btn');
        const loadingSpinner = document.getElementById('loading-spinner');
        const contextWarning = document.getElementById('context-warning');

        let chatHistory = [];
        const CONTEXT_LIMIT = 20; // 10 turnos de conversaci贸n

        // --- Funciones de renderizado ---
        function appendMessage(role, content, sources = []) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('chat-message', `${role}-message`);

            const contentDiv = document.createElement('div');
            contentDiv.innerHTML = marked.parse(content);
            messageDiv.appendChild(contentDiv);

            if (sources.length > 0) {
                const sourcesContainer = document.createElement('div');
                sourcesContainer.className = 'sources-container';

                const toggleButton = document.createElement('button');
                toggleButton.className = 'btn btn-secondary sources-toggle-btn';
                toggleButton.innerHTML = `<span></span> Fuentes (${sources.length})`;
                
                const sourcesList = document.createElement('div');
                sourcesList.className = 'sources-list';
                sourcesList.style.display = 'none'; // Oculta por defecto

                sources.forEach(source => {
                    const sourceCard = document.createElement('a');
                    sourceCard.className = 'source-card';
                    sourceCard.href = source.source_url || '#';
                    sourceCard.target = '_blank';
                    const year = source.publication_year ? ` - ${source.publication_year}` : '';
                    sourceCard.innerHTML = `<strong>${source.title || 'Fuente desconocida'}</strong><p>${source.publisher || 'Publicador no disponible'}${year}</p>`;
                    sourcesList.appendChild(sourceCard);
                });

                toggleButton.addEventListener('click', () => {
                    const isHidden = sourcesList.style.display === 'none';
                    sourcesList.style.display = isHidden ? 'grid' : 'none';
                });

                sourcesContainer.appendChild(toggleButton);
                sourcesContainer.appendChild(sourcesList);
                messageDiv.appendChild(sourcesContainer);
            }

            chatWindow.appendChild(messageDiv);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        function displayLoading(isLoading) {
            loadingSpinner.style.display = isLoading ? 'flex' : 'none';
        }

        function checkContextWarning() {
            if (chatHistory.length > CONTEXT_LIMIT) {
                contextWarning.style.display = 'block';
            } else {
                contextWarning.style.display = 'none';
            }
        }

        // --- L贸gica del Chat ---
        async function handleFormSubmit(event) {
            event.preventDefault();
            const query = chatInput.value.trim();
            if (!query) return;

            appendMessage('user', query);
            chatHistory.push({ role: 'user', content: query });
            chatInput.value = '';
            chatInput.style.height = 'auto';

            checkContextWarning();
            displayLoading(true);

            const reasoningTrace = document.getElementById('reasoning-trace');
            const traceContent = document.getElementById('trace-content');
            reasoningTrace.style.display = 'block'; // Asegurarse de que el contenedor sea visible
            traceContent.innerHTML = ''; // Limpiar el rastro anterior

            const encodedQuery = encodeURIComponent(query);
            const eventSource = new EventSource(`/chat/stream?query=${encodedQuery}`);

            eventSource.onmessage = function(event) {
                console.log("Evento recibido:", event.data); // DEBUG: A帽adido para depuraci贸n
                const data = JSON.parse(event.data);

                switch (data.type) {
                    case 'status':
                        displayLoading(false); // Ocultar el spinner principal
                        traceContent.innerHTML = `<p class="trace-status">${data.message}</p>`;
                        break;
                    case 'plan':
                        let planHtml = '<ul>';
                        data.data.steps.forEach((step, index) => {
                            planHtml += `<li id="step-${index + 1}">${step}</li>`;
                        });
                        planHtml += '</ul>';
                        traceContent.innerHTML = planHtml;
                        break;
                    case 'sub_answer':
                        const stepElement = document.getElementById(`step-${data.step}`);
                        if (stepElement) {
                            stepElement.classList.add('completed');
                            stepElement.innerHTML += ' 锔';
                        }
                        break;
                    case 'final_answer':
                        displayLoading(false);
                        appendMessage('assistant', data.data.answer, data.data.sources);
                        chatHistory.push({ role: 'assistant', content: data.data.answer });
                        break;
                    case 'done':
                        reasoningTrace.style.display = 'none';
                        eventSource.close();
                        checkContextWarning();
                        break;
                    case 'error':
                        displayLoading(false);
                        appendMessage('assistant', `Lo siento, ocurri贸 un error: ${data.message}`);
                        eventSource.close();
                        break;
                }
            };

            eventSource.onerror = function(err) {
                console.error("EventSource failed:", err);
                displayLoading(false);
                appendMessage('assistant', 'Lo siento, ocurri贸 un error de conexi贸n al procesar la respuesta.');
                eventSource.close();
            };
        }

        function startNewChat() {
            chatHistory = [];
            chatWindow.innerHTML = '';
            appendMessage('assistant', 'Hola, 驴en qu茅 puedo ayudarte hoy?');
            checkContextWarning();
            return false; // Para prevenir el comportamiento por defecto del enlace
        }

        // --- Event Listeners ---
        chatForm.addEventListener('submit', handleFormSubmit);
        newChatBtn.addEventListener('click', startNewChat);
        chatInput.addEventListener('input', () => {
            chatInput.style.height = 'auto';
            chatInput.style.height = `${chatInput.scrollHeight}px`;
        });

        // Iniciar el chat al cargar la p谩gina
        startNewChat();

    </script>
</body>
</html>