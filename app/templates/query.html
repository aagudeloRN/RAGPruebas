<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat de Conocimiento</title>
    <link rel="stylesheet" href="/static/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
    <div class="container query-container">
        <div class="main-background">
            <header>
                <h1>Chat de Conocimiento</h1>
                <p>Inicia una conversación con tus documentos.</p>
                <nav class="main-nav">
                    <!-- <a href="/" class="nav-button">Cargar Documento</a> -->
                    <a href="/library" class="nav-button">Ver Biblioteca</a>
                    <button id="new-chat-btn" class="nav-button">Nueva Conversación</button>
                </nav>
            </header>

            <div id="chat-window" class="chat-window"></div>

            <div id="loading-spinner" class="loading-spinner" style="display: none;">
                <div class="spinner"></div>
                <p>Pensando...</p>
            </div>

            <div class="chat-input-area">
                <form id="chat-form">
                    <textarea id="chat-input" name="query" rows="1" placeholder="Escribe tu pregunta..."></textarea>
                    <button type="submit" class="btn btn-primary">Enviar</button>
                </form>
                <div id="context-warning" class="context-warning" style="display: none;">
                    La conversación es larga. Para obtener mejores resultados, considera <a href="#" onclick="startNewChat()">iniciar una nueva conversación</a>.
                </div>
            </div>
        </div>
    </div>

    <script>
        const chatWindow = document.getElementById('chat-window');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const newChatBtn = document.getElementById('new-chat-btn');
        const loadingSpinner = document.getElementById('loading-spinner');
        const contextWarning = document.getElementById('context-warning');

        let chatHistory = [];
        const CONTEXT_LIMIT = 20; // 10 turnos de conversación

        // --- Funciones de renderizado ---
        function appendMessage(role, content, sources = []) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('chat-message', `${role}-message`);

            const contentDiv = document.createElement('div');
            contentDiv.innerHTML = marked.parse(content);
            messageDiv.appendChild(contentDiv);

            if (sources.length > 0) {
                const sourcesContainer = document.createElement('div');
                sourcesContainer.className = 'sources-container';

                const toggleButton = document.createElement('button');
                toggleButton.className = 'btn btn-secondary sources-toggle-btn';
                toggleButton.innerHTML = `<span>📚</span> Fuentes (${sources.length})`;
                
                const sourcesList = document.createElement('div');
                sourcesList.className = 'sources-list';
                sourcesList.style.display = 'none'; // Oculta por defecto

                sources.forEach(source => {
                    const sourceCard = document.createElement('a');
                    sourceCard.className = 'source-card';
                    sourceCard.href = source.source_url || '#';
                    sourceCard.target = '_blank';
                    const year = source.publication_year ? ` - ${source.publication_year}` : '';
                    sourceCard.innerHTML = `<strong>${source.title || 'Fuente desconocida'}</strong><p>${source.publisher || 'Publicador no disponible'}${year}</p>`;
                    sourcesList.appendChild(sourceCard);
                });

                toggleButton.addEventListener('click', () => {
                    const isHidden = sourcesList.style.display === 'none';
                    sourcesList.style.display = isHidden ? 'grid' : 'none';
                });

                sourcesContainer.appendChild(toggleButton);
                sourcesContainer.appendChild(sourcesList);
                messageDiv.appendChild(sourcesContainer);
            }

            chatWindow.appendChild(messageDiv);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        function displayLoading(isLoading) {
            loadingSpinner.style.display = isLoading ? 'flex' : 'none';
        }

        function checkContextWarning() {
            if (chatHistory.length > CONTEXT_LIMIT) {
                contextWarning.style.display = 'block';
            } else {
                contextWarning.style.display = 'none';
            }
        }

        // --- Lógica del Chat ---
        async function handleFormSubmit(event) {
            event.preventDefault();
            const query = chatInput.value.trim();
            if (!query) return;

            appendMessage('user', query);
            chatHistory.push({ role: 'user', content: query });
            chatInput.value = '';
            chatInput.style.height = 'auto';

            checkContextWarning();
            displayLoading(true);

            try {
                const response = await fetch('/chat/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: query, history: chatHistory.slice(0, -1) })
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || 'Error en el servidor.');
                }

                const data = await response.json();

                appendMessage('assistant', data.answer, data.sources);
                chatHistory.push({ role: 'assistant', content: data.answer });

            } catch (error) {
                appendMessage('assistant', `Lo siento, ocurrió un error: ${error.message}`);
            } finally {
                displayLoading(false);
                checkContextWarning();
            }
        }

        function startNewChat() {
            chatHistory = [];
            chatWindow.innerHTML = '';
            appendMessage('assistant', 'Hola, ¿en qué puedo ayudarte hoy?');
            checkContextWarning();
            return false; // Para prevenir el comportamiento por defecto del enlace
        }

        // --- Event Listeners ---
        chatForm.addEventListener('submit', handleFormSubmit);
        newChatBtn.addEventListener('click', startNewChat);
        chatInput.addEventListener('input', () => {
            chatInput.style.height = 'auto';
            chatInput.style.height = `${chatInput.scrollHeight}px`;
        });

        // Iniciar el chat al cargar la página
        startNewChat();

    </script>
</body>
</html>
