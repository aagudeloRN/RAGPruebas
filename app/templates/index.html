<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Vigilancia e Inteligencia</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <div class="container">
        <div class="main-background">
        <header>
            <h1>Sistema de Vigilancia e Inteligencia</h1>
            <p>Cargue un documento PDF para analizarlo y añadirlo a la base de conocimiento.</p>
        </header>

        <nav class="main-nav">
            <a href="/library" class="nav-button">Ver Biblioteca de Documentos</a>
            <a href="/query" class="nav-button">Consultar Información (RAG)</a>
        </nav>

        <div id="message-area"></div>

        <div class="form-container">
            <form id="upload-form" action="/upload-document/" method="post" enctype="multipart/form-data">
                <div id="drop-zone" class="drop-zone">
                    <p>Arrastre y suelte un archivo PDF aquí o haga clic para seleccionar uno.</p>
                    <input type="file" id="file" name="file" accept="application/pdf" required hidden>
                </div>
            </form>
            <div id="loading-indicator" style="display: none;">
                <p>Extrayendo metadatos, por favor espere...</p>
                <div class="loader"></div>
            </div>
        </div>
        </div>
    </div>

    <script>
        const form = document.getElementById('upload-form');
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file');
        const messageArea = document.getElementById('message-area');
        const loadingIndicator = document.getElementById('loading-indicator');

        const showMessage = (text, type) => {
            messageArea.innerHTML = `<div class="message ${type}">${text}</div>`;
        };

        const handleFileSelect = async (file) => {
            if (!file || file.type !== 'application/pdf') {
                showMessage('Por favor, seleccione un archivo PDF válido.', 'error');
                return;
            }

            dropZone.style.display = 'none';
            loadingIndicator.style.display = 'block';
            showMessage('Archivo seleccionado. Extrayendo metadatos...', 'info');

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/upload-document/', {
                    method: 'POST',
                    body: formData,
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Error en el servidor.');
                }

                const result = await response.json();
                sessionStorage.setItem('validationMetadata', JSON.stringify(result.metadata));
                window.location.href = `/validate-metadata/${result.temp_id}`;

            } catch (error) {
                showMessage(`Error: ${error.message}`, 'error');
                loadingIndicator.style.display = 'none';
                dropZone.style.display = 'block';
            }
        };

        // Abrir selector de archivo al hacer clic en la zona
        dropZone.addEventListener('click', () => fileInput.click());

        // Manejar cambio en el input de archivo
        fileInput.addEventListener('change', () => {
            if (fileInput.files.length > 0) {
                handleFileSelect(fileInput.files[0]);
            }
        });

        // Manejar eventos de drag & drop
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drag-over');
        });

        dropZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            if (e.dataTransfer.files.length > 0) {
                fileInput.files = e.dataTransfer.files;
                handleFileSelect(e.dataTransfer.files[0]);
            }
        });
    </script>
</body>
</html>

